# Redis持久化

## RDB

触发机制

- 手动
  
  save命令：阻塞当前redis服务器，直到RDB过程完成为止
  
  bgsave命令：Redis进程执行fork操作创建子进程，RDB持久化操作交给子进程来完成，阻塞只会发生在fork阶段

- 自动
  
  save的配置：save m n 表示在m秒内存在n次修改就自动触发bgsave
  
  debug reload：重新加载redis时会自动触发save操作
  
  shutdown命令时会自动触发bgsave

在redis.conf文件里改

优点：

1. 性能高效：RDB持久化通过将Redis数据集转化为紧凑的二进制文件进行存储，因此在数据恢复时具有极高的性能和效率。这使得RDB持久化在进行定期备份或快速恢复数据时非常有用。

2. 空间占用小：RDB文件是紧凑的二进制格式，相对于其他持久化方式（如AOF），RDB文件通常占用更少的磁盘空间。

3. 良好的兼容性：RDB持久化对Redis的版本兼容性较好。即使在不同版本之间，RDB文件的加载和恢复也往往能够正常进行。

4. 适用于灾难恢复：由于RDB文件是整个数据集的快照，它适用于进行灾难性的数据恢复。在出现故障或数据丢失时，可以使用RDB文件快速恢复Redis数据。

缺点：

1. 数据丢失风险：由于RDB持久化采用定期快照的方式进行数据存储，如果Redis发生故障或意外崩溃，最后一次快照之后的数据将会丢失。因此，在RDB持久化中存在一定的数据丢失风险。

2. 高延迟：RDB持久化需要触发快照操作，这可能会导致Redis在进行持久化时出现较高的延迟。快照操作通常会在主线程中进行，因此在生成快照期间，Redis服务器可能会暂停响应客户端请求。

3. 不适用于实时数据备份：由于RDB持久化是定期生成快照的方式，因此无法提供实时的数据备份。如果需要更频繁或实时的数据备份，可以考虑使用AOF（Append-Only File）持久化方式。

## AOF

首先要在redis.conf的配置文件中修改appendonly 为 yes 开启aof

aof操作会把命令按照redis协议格式写入aof文件中

同步策略

- always：写一条命令就写入aof文件（同步高，性能低）

- everysec：每秒将命令集体写入aof文件（同步中（可能丢失1s内数据），性能中，默认）

- no：不进行同步，由操作系统管理，通常同步周期为30s（同步差，性能高）

随着aof 文件越来越大，redis会对aof文件进行重写（压缩，并省略无效记录）

重写机制有两种

- 手动
  
  bgrewriteaof命令

- 自动
  
  redis.conf配置文件中的
  
  auto-aof-rewrite-min-size:表示aof重写时文件最小体积，默认64mb
  
  auto-aof-rewrite-percentage:当前aof文件空间与上一次aof文件空间的百分比
